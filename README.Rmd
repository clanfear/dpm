---
output: github_document
---
<!-- README.md is generated from README.Rmd. Please edit that file -->
# clfe

[![GitHub tag](https://img.shields.io/github/tag/jacob-long/clfe.svg?label=Github)](https://github.com/jacob-long/clfe) [![Travis-CI Build Status](https://travis-ci.org/jacob-long/clfe.svg?branch=master)](https://travis-ci.org/jacob-long/clfe)
[![AppVeyor Build Status](https://ci.appveyor.com/api/projects/status/github/jacob-long/clfe?branch=master&svg=true)](https://ci.appveyor.com/project/jacob-long/clfe)
[![Coverage Status](https://img.shields.io/codecov/c/github/jacob-long/clfe/master.svg)](https://codecov.io/github/jacob-long/clfe?branch=master)


```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = F,
  comment = "#",
  fig.path = "README-"
)
```

This R package implements the cross-lagged panel model with fixed effects
described by Allison, Williams, and Moral-Benito (2017). It is effectively
a convenience wrapper to the `lavaan` package. This package will reshape your
data, specify the model properly, and fit it with `lavaan`.

Note: This is ALPHA software. Expect bugs and missing functionality.
Cross-reference all results with xtdpdml for Stata. Go to
[https://www3.nd.edu/~rwilliam/dynamic/](https://www3.nd.edu/~rwilliam/dynamic/)
to learn about xtdpdml and the underlying method. You may also be interested
in the article by Paul Allison, Richard Williams, and Enrique Moral-Benito in
**Socius**, accessible
[here](http://journals.sagepub.com/doi/full/10.1177/2378023117710578)

# Installation

You will need to the `devtools` package installed to install this package
from Github as well as its companion package,
[`panelr`](https://github.com/jacob-long/panelr).

```{r eval = F}
install.packages("devtools")
devtools::install_github("jacob-long/panelr")
devtools::install_github("jacob-long/clfe")
```

Also note this package's dependencies: `lavaan`, `stringr`

# Usage

This package assumes your data are in *long* format, with each row representing
a single observation of a single participant. Contrast this with *wide* format
in which each row contains all observations of a single participant. 
Better compatibility with wide data will be implemented in a future release.

Load the package, use built-in wages data.

```{r message = F}
library(panelr)
library(clfe)
data("WageData")
```

This next line of code converts the data to class `panel_data`, which is a class
specific to the [`panelr`](https://github.com/jacob-long/panelr) that helps
to simplify the treatment of the long-form
panel data. You don't have to do this, but it saves you from providing 
`id` and `wave` arguments to the model fitting function each time you use it.

```{r}
wages <- panel_data(WageData, id = id, wave = t)
```

## Basic formula syntax

The formula syntax used in this package is meant to be as similar to a typical
regression model as possible. 

The most basic model can be specified like any other: `y ~ x`, where `y` is
the dependent variable and `x` is a time-varying predictor. If you would like 
to include time-invariant predictors, you will make the formula consist of two 
parts, separated with a bar (`|`) like so: `y ~ x | z` where z is a time 
invariant predictor, like ethnicity. 

One of the innovations of the method, however, is the notion of predetermined,
or sequentially exogenous, predictors. To specify a model with a predetermined
variable, put the variable within a `pre` function, `y ~ pre(x1) + x2 | z`. 
This tells the function that `x1` is predetermined while `x2` is strictly 
exogenous by assumption. You could have multiple predetermined predictors as 
well (e.g., `y ~ pre(x1) + pre(x2) | z`). 

As implied by the "cross-lagged" terminology, you may also fit models with 
lagged predictors. Simply apply the lag function to the lagged predictors in 
the formula: `y ~ pre(lag(x1)) + lag(x2) | z`. To specify more than 1 lag, 
just provide it as an argument. For instance,
`y ~ pre(lag(x1, 2)) + lag(x2) | z` will use 2 lags of the `x1` variable.

## *Socius* article example

This will replicate the analysis of the wages data in the *Socius* article that
describes these models.

Note that to get matching standard errors, set `information = "observed"` to 
override `lavaan`'s default, `information = "expected"`.

```{r}
fit <- clfe(wks ~ pre(lag(union)) + lag(lwage) | ed, data = wages,
           err.inv = TRUE,
           information = "observed")
summary(fit)
```

Any arguments supplied other than those that are documented within the 
`clfe` function are passed on to `sem` from `lavaan`.

## Other features

### Lavaan syntax only

If you just want the `lavaan` model specification and don't want this package
to fit the model for you, you can set `print.only = TRUE`.

```{r}
clfe(wks ~ pre(lag(union)) + lag(lwage) | ed, data = wages, err.inv = TRUE,
     print.only = TRUE)
```

### Extract components

Alternately, you can extract the `lavaan` model syntax and wide-formatted data
from the fitted model object to do your own fitting.

```{r}
head(fit$wide_data)
```

The `lavaan` model specification is stored as `fit$mod_string`. Tip: To print
the `mod_string` to your console, don't use the `print` function, use the 
`cat` function because it will format the line breaks appropriately.

You can also get the fitted `lavaan` model object at `fit$fit`.

### Get full `lavaan` summary

While you could extract the `lavaan` model and apply any of `lavaan`'s 
functions to it (and you should!), as a convenience you can use 
`lav_summary` to get `lavaan`'s summary of the model.

### Missing data

Take advantage of `lavaan`'s missing data handling by using the
`missing = "fiml"` argument, which is passed to `sem`.

# Missing features/problems

* CFI/TLI fit measures are much different than Stata's and consistently
more optimistic. For now, they are not printed with the summary because they
are probably misleading.
* You cannot use multiple lags of the same predictor (e.g., `y ~ x + lag(x)`).
* The function does not yet support input data that is already in wide format.
* You cannot apply arbitrary functions to variables in the formula like you 
can with regression models. For instance, a specification like `y ~ scale(x)`
will cause an error.

The following `xtdpdml` (Stata) options are not implemented:

* xfree
* yfree
* re
* ylag
* std

# Reference

Allison, P. D., Williams, R., & Moral-Benito, E. (2017). Maximum likelihood for
cross-lagged panel models with fixed effects. *Socius*, *3*, 1-17.
